name: FC Online ì»¤ë®¤ë‹ˆí‹° í¬ë¡¤ë§

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      max_pages:
        description: 'ìµœëŒ€ í˜ì´ì§€ ìˆ˜ (0 = ë¬´ì œí•œ)'
        required: false
        default: '0'
        type: string

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: community-crawler
  cancel-in-progress: false

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # ìµœëŒ€ 6ì‹œê°„

    # í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì •
    env:
      TZ: Asia/Seoul

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ (github-actions-community ë¸Œëœì¹˜)
      - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: github-actions-community
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (rebase ìœ„í•´)

      # 2. Node.js ì„¤ì •
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/crawler-fconline-community/package-lock.json

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: backend/crawler-fconline-community
        run: npm ci

      # 4. Puppeteerìš© ë¸Œë¼ìš°ì € ì„¤ì¹˜
      - name: ğŸŒ Chromium ë¸Œë¼ìš°ì € ì„¤ì¹˜
        working-directory: backend/crawler-fconline-community
        run: npx puppeteer browsers install chrome

      # 5. ë°ì´í„° í´ë” ìƒì„±
      - name: ğŸ“ ë°ì´í„° í´ë” ì¤€ë¹„
        working-directory: backend/crawler-fconline-community
        run: mkdir -p data

      # 6. í¬ë¡¤ë§ ì‹¤í–‰
      - name: ğŸ•·ï¸ ì»¤ë®¤ë‹ˆí‹° í¬ë¡¤ë§ ì‹¤í–‰
        working-directory: backend/crawler-fconline-community
        run: |
          echo "ğŸ• ì‹œì‘ ì‹œê°„ (KST): $(date '+%Y-%m-%d %H:%M:%S')"
          node ./src/crawler-community.js
          echo "ğŸ• ì¢…ë£Œ ì‹œê°„ (KST): $(date '+%Y-%m-%d %H:%M:%S')"
        env:
          MAX_PAGES: ${{ github.event.inputs.max_pages }}

      # 7. ìˆ˜ì§‘ ê²°ê³¼ ìš”ì•½
      - name: ğŸ“Š ìˆ˜ì§‘ ê²°ê³¼ ìš”ì•½
        working-directory: backend/crawler-fconline-community
        run: |
          echo "=== ìˆ˜ì§‘ ê²°ê³¼ (KST: $(date '+%Y-%m-%d %H:%M:%S')) ==="
          
          # visited.json í™•ì¸
          if [ -f data/visited.json ]; then
            VISITED_COUNT=$(cat data/visited.json | jq '.visited | length')
            echo "ğŸ“‹ ì´ ë°©ë¬¸ ê²Œì‹œê¸€: ${VISITED_COUNT}ê°œ"
          fi
          
          # ì˜¤ëŠ˜ ë‚ ì§œ í´ë” í™•ì¸
          TODAY=$(date '+%y-%m-%d')
          if [ -d "data/${TODAY}" ]; then
            if [ -f "data/${TODAY}/posts.jsonl" ]; then
              POST_COUNT=$(wc -l < "data/${TODAY}/posts.jsonl" | tr -d ' ')
              echo "ğŸ“ ì˜¤ëŠ˜ ìˆ˜ì§‘ëœ ê²Œì‹œê¸€: ${POST_COUNT}ê°œ"
              echo ""
              echo "ìµœê·¼ 5ê°œ ê²Œì‹œê¸€:"
              tail -5 "data/${TODAY}/posts.jsonl" | jq -r '.title // "ì œëª©ì—†ìŒ"' 2>/dev/null || echo "(íŒŒì‹± ì˜¤ë¥˜)"
            fi
          fi

      # 8. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ (ì¶©ëŒ ë°©ì§€)
      - name: ğŸ’¾ ìˆ˜ì§‘ ë°ì´í„° ì €ì¥
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          VISITED_FILE="backend/crawler-fconline-community/data/visited.json"
          
          # visited.jsonì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
          if [ ! -f "$VISITED_FILE" ]; then
            echo "ğŸ“­ visited.jsonì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi
          
          # í‘¸ì‹œ ì „ ìµœì‹  ìƒíƒœ pull (ì»¤ë°‹ ì „ì— ë¨¼ì €!)
          git stash push -m "crawl-data" -- "$VISITED_FILE" || true
          git pull origin github-actions-community --rebase || true
          git stash pop || true
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸ (visited.jsonë§Œ ì»¤ë°‹ - jsonlì€ .gitignore)
          git add "$VISITED_FILE"
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi
          
          COMMIT_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
          git commit -m "ğŸ“Š ë°©ë¬¸ ê¸°ë¡ ì—…ë°ì´íŠ¸: ${COMMIT_TIME}"
          
          # í‘¸ì‹œ (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
          for i in 1 2 3; do
            if git push origin github-actions-community; then
              echo "âœ… github-actions-community ë¸Œëœì¹˜ì— ì €ì¥ ì™„ë£Œ"
              exit 0
            fi
            echo "âš ï¸ í‘¸ì‹œ ì‹¤íŒ¨, ì¬ì‹œë„ ${i}/3..."
            git pull origin github-actions-community --rebase || true
            sleep 2
          done
          
          echo "âŒ í‘¸ì‹œ ì‹¤íŒ¨. ì•„í‹°íŒ©íŠ¸ì—ì„œ ë°ì´í„° í™•ì¸í•˜ì„¸ìš”."
          exit 1

      # 9. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë°±ì—…ìš©)
      - name: ğŸ“¤ ë°ì´í„° ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: crawl-data-${{ github.run_id }}
          path: backend/crawler-fconline-community/data/
          retention-days: 30
